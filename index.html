<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Means Clustering Pro | Phân tích Dữ liệu</title>
    
    <!-- Thư viện UI: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Thư viện Biểu đồ: Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <!-- Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Font chữ Google -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .step-card { transition: all 0.3s ease; }
        .step-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white py-6 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-2xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-diagram-project"></i> K-Means Visualization
            </h1>
            <p class="text-sm opacity-90 mt-2 md:mt-0">Công cụ phân cụm & Vẽ biểu đồ tự động</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-6xl">
        
        <!-- INPUT SECTION -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <!-- Cột 1: Cấu hình Dữ liệu -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-md p-6 border border-slate-100">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-bold text-slate-700"><i class="fa-solid fa-database text-blue-500 mr-2"></i>Dữ liệu đầu vào</h2>
                    <div class="space-x-2">
                        <button onclick="loadSampleData()" class="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full hover:bg-emerald-200 font-semibold transition">
                            <i class="fa-solid fa-rotate-left"></i> Nạp bài tập mẫu
                        </button>
                        <button onclick="resetData()" class="text-xs bg-red-100 text-red-700 px-3 py-1 rounded-full hover:bg-red-200 font-semibold transition">
                            <i class="fa-solid fa-trash"></i> Xóa trắng
                        </button>
                    </div>
                </div>

                <!-- Nhập số lượng N -->
                <div class="flex gap-4 items-end mb-4">
                    <div class="w-full md:w-1/3">
                        <label class="block text-sm font-medium text-slate-600 mb-1">Số lượng điểm (N)</label>
                        <input type="number" id="inputN" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="Ví dụ: 18">
                    </div>
                    <button onclick="generateTable()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition shadow-md md:mb-[1px]">
                        <i class="fa-solid fa-table"></i> Tạo bảng nhập
                    </button>
                </div>

                <!-- Bảng nhập tọa độ -->
                <div class="overflow-y-auto max-h-[300px] border rounded-lg bg-slate-50">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-200 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-center w-16">STT</th>
                                <th class="px-4 py-3 text-center">Tọa độ X1</th>
                                <th class="px-4 py-3 text-center">Tọa độ X2</th>
                            </tr>
                        </thead>
                        <tbody id="inputTableBody">
                            <!-- Dòng dữ liệu sẽ được sinh ra ở đây -->
                            <tr><td colspan="3" class="text-center py-8 text-slate-400">Vui lòng nhập N và nhấn "Tạo bảng" hoặc chọn "Nạp bài tập mẫu"</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Cột 2: Cấu hình Tâm & Chạy -->
            <div class="flex flex-col gap-6">
                <!-- Cấu hình Tâm -->
                <div class="bg-white rounded-xl shadow-md p-6 border border-slate-100 h-full">
                    <h2 class="text-xl font-bold text-slate-700 mb-4 border-b pb-2"><i class="fa-solid fa-crosshairs text-rose-500 mr-2"></i>Chọn Tâm Khởi Tạo</h2>
                    <p class="text-xs text-slate-500 mb-4">Nhập số thứ tự (STT) của điểm dữ liệu muốn chọn làm tâm.</p>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-red-600 uppercase mb-1">Tâm 1 (Đỏ)</label>
                            <input type="number" id="c1_id" value="2" class="w-full px-3 py-2 border border-red-200 bg-red-50 rounded-lg focus:ring-red-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-green-600 uppercase mb-1">Tâm 2 (Xanh lá)</label>
                            <input type="number" id="c2_id" value="10" class="w-full px-3 py-2 border border-green-200 bg-green-50 rounded-lg focus:ring-green-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-blue-600 uppercase mb-1">Tâm 3 (Xanh dương)</label>
                            <input type="number" id="c3_id" value="5" class="w-full px-3 py-2 border border-blue-200 bg-blue-50 rounded-lg focus:ring-blue-500 outline-none">
                        </div>
                    </div>

                    <button onclick="runKMeans()" class="w-full mt-6 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transform active:scale-95 transition flex justify-center items-center gap-2">
                        <i class="fa-solid fa-play"></i> CHẠY PHÂN TÍCH
                    </button>
                </div>
            </div>
        </div>

        <!-- RESULT SECTION -->
        <div id="resultArea" class="space-y-8 hidden">
            <div class="flex items-center gap-4">
                <div class="h-px bg-slate-300 flex-1"></div>
                <h2 class="text-2xl font-bold text-slate-700 uppercase tracking-wide">Kết Quả Phân Tích</h2>
                <div class="h-px bg-slate-300 flex-1"></div>
            </div>
            
            <!-- Nội dung kết quả sẽ được JS chèn vào đây -->
        </div>

    </main>

    <footer class="bg-slate-800 text-slate-400 py-6 mt-12 text-center text-sm">
        <p>Công cụ hỗ trợ học tập môn Khai thác dữ liệu.</p>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- 1. DATA MANAGEMENT ---
        let dataPoints = [];

        // Dữ liệu mẫu từ bài tập
        const sampleData = [
            [1, 5], [3, 5], [2, 13], [3, 4], [7, 5], [2, 6], 
            [4, 1], [14, 3], [4, 7], [4, 6], [7, 11], [6, 2], 
            [8, 1], [4, 8], [8, 3], [1, 14], [3, 6], [7, 12]
        ];

        function loadSampleData() {
            document.getElementById('inputN').value = 18;
            generateTable(sampleData);
        }

        function resetData() {
            document.getElementById('inputN').value = '';
            document.getElementById('inputTableBody').innerHTML = `<tr><td colspan="3" class="text-center py-8 text-slate-400">Đã xóa dữ liệu</td></tr>`;
            document.getElementById('resultArea').classList.add('hidden');
            document.getElementById('resultArea').innerHTML = '';
        }

        function generateTable(prefillData = null) {
            const n = parseInt(document.getElementById('inputN').value);
            const tbody = document.getElementById('inputTableBody');
            
            if (!n || n <= 0) {
                alert("Vui lòng nhập số lượng N hợp lệ!");
                return;
            }

            tbody.innerHTML = '';
            
            for (let i = 0; i < n; i++) {
                const xVal = prefillData ? prefillData[i][0] : '';
                const yVal = prefillData ? prefillData[i][1] : '';

                const row = `
                    <tr class="bg-white border-b hover:bg-slate-50">
                        <td class="px-4 py-2 text-center font-bold text-slate-500">${i}</td>
                        <td class="px-4 py-2 text-center">
                            <input type="number" id="x_${i}" value="${xVal}" class="w-full text-center bg-transparent border-b border-dashed border-slate-300 focus:border-blue-500 focus:outline-none py-1" placeholder="x1">
                        </td>
                        <td class="px-4 py-2 text-center">
                            <input type="number" id="y_${i}" value="${yVal}" class="w-full text-center bg-transparent border-b border-dashed border-slate-300 focus:border-blue-500 focus:outline-none py-1" placeholder="x2">
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            }
        }

        function readDataFromTable() {
            const n = parseInt(document.getElementById('inputN').value);
            const points = [];
            for (let i = 0; i < n; i++) {
                const x = parseFloat(document.getElementById(`x_${i}`).value);
                const y = parseFloat(document.getElementById(`y_${i}`).value);
                if (isNaN(x) || isNaN(y)) {
                    alert(`Vui lòng nhập đầy đủ tọa độ cho điểm STT ${i}`);
                    return null;
                }
                points.push({id: i, x: x, y: y});
            }
            return points;
        }

        // --- 2. K-MEANS LOGIC ---
        
        function getDistance(p1, p2) {
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
        }

        function round2(num) {
            return Math.round((num + Number.EPSILON) * 100) / 100;
        }

        function runKMeans() {
            // 1. Lấy dữ liệu
            dataPoints = readDataFromTable();
            if (!dataPoints) return;

            // 2. Lấy tâm
            const c1_id = parseInt(document.getElementById('c1_id').value);
            const c2_id = parseInt(document.getElementById('c2_id').value);
            const c3_id = parseInt(document.getElementById('c3_id').value);

            // Validate tâm
            if (!dataPoints[c1_id] || !dataPoints[c2_id] || !dataPoints[c3_id]) {
                alert("STT Tâm khởi tạo không tồn tại trong dữ liệu!");
                return;
            }

            const resultArea = document.getElementById('resultArea');
            resultArea.innerHTML = `
                <div class="flex items-center gap-4 mb-6">
                    <div class="h-px bg-slate-300 flex-1"></div>
                    <h2 class="text-2xl font-bold text-slate-700 uppercase tracking-wide">Kết Quả Phân Tích</h2>
                    <div class="h-px bg-slate-300 flex-1"></div>
                </div>
            `;
            resultArea.classList.remove('hidden');

            let centers = [
                { ...dataPoints[c1_id], label: 'C1', color: 'red' },
                { ...dataPoints[c2_id], label: 'C2', color: 'green' },
                { ...dataPoints[c3_id], label: 'C3', color: 'blue' }
            ];

            // --- BƯỚC KHỞI TẠO ---
            renderIteration(0, dataPoints, centers, [], "TRẠNG THÁI KHỞI TẠO (INITIAL)", true);

            // --- VÒNG LẶP ---
            let maxIterations = 5;
            let prevAssignments = [];

            for (let iter = 1; iter <= maxIterations; iter++) {
                let assignments = [];
                let clusterGroups = [[], [], []];
                let tableRows = "";

                // Tính khoảng cách & Gán nhóm
                dataPoints.forEach(point => {
                    let dists = centers.map(c => getDistance(point, c));
                    let minD = Math.min(...dists);
                    let clusterIndex = dists.indexOf(minD); // Ưu tiên index nhỏ (theo đề)
                    
                    assignments.push(clusterIndex);
                    clusterGroups[clusterIndex].push(point);

                    // HTML cho bảng
                    const badges = [
                        `<span class="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded">C1</span>`,
                        `<span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded">C2</span>`,
                        `<span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">C3</span>`
                    ];

                    tableRows += `
                        <tr class="border-b hover:bg-slate-50 transition">
                            <td class="px-4 py-2 font-medium">${point.id}</td>
                            <td class="px-4 py-2">(${point.x}, ${point.y})</td>
                            <td class="px-4 py-2 ${clusterIndex===0 ? 'font-bold text-red-600':''}">${round2(dists[0])}</td>
                            <td class="px-4 py-2 ${clusterIndex===1 ? 'font-bold text-green-600':''}">${round2(dists[1])}</td>
                            <td class="px-4 py-2 ${clusterIndex===2 ? 'font-bold text-blue-600':''}">${round2(dists[2])}</td>
                            <td class="px-4 py-2 text-center">${badges[clusterIndex]}</td>
                        </tr>
                    `;
                });

                // Cập nhật tâm mới
                let newCenters = [];
                let calcInfoHtml = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">`;
                
                for(let i=0; i<3; i++) {
                    let group = clusterGroups[i];
                    let newX, newY, desc;
                    const colors = ["text-red-600", "text-green-600", "text-blue-600"];
                    const bgColors = ["bg-red-50", "bg-green-50", "bg-blue-50"];
                    const borders = ["border-red-200", "border-green-200", "border-blue-200"];

                    if (group.length === 0) {
                        newX = centers[i].x; newY = centers[i].y;
                        desc = "Giữ nguyên (Cụm rỗng)";
                    } else {
                        let sumX = group.reduce((s, p) => s + p.x, 0);
                        let sumY = group.reduce((s, p) => s + p.y, 0);
                        newX = round2(sumX / group.length);
                        newY = round2(sumY / group.length);
                        desc = `Trung bình ${group.length} điểm`;
                    }
                    newCenters.push({ x: newX, y: newY, label: `C${i+1}`, color: centers[i].color });

                    calcInfoHtml += `
                        <div class="p-3 rounded-lg border ${borders[i]} ${bgColors[i]}">
                            <h4 class="font-bold ${colors[i]} text-sm uppercase">Tâm C${i+1} Mới</h4>
                            <div class="text-xs text-slate-600 mt-1">${desc}</div>
                            <div class="text-lg font-mono font-bold mt-1">(${newX}, ${newY})</div>
                        </div>
                    `;
                }
                calcInfoHtml += `</div>`;

                // Render UI cho Iteration này
                renderIteration(iter, dataPoints, newCenters, assignments, `KẾT QUẢ LẦN LẶP ${iter}`, false, tableRows, calcInfoHtml, centers);

                // Cập nhật biến cho vòng sau
                centers = newCenters;

                // Check Convergence
                let isStable = (prevAssignments.length > 0) && (JSON.stringify(assignments) === JSON.stringify(prevAssignments));
                if (isStable) {
                    resultArea.innerHTML += `
                        <div class="bg-emerald-100 border-l-4 border-emerald-500 text-emerald-700 p-4 rounded shadow-sm flex items-center gap-3 mt-6">
                            <i class="fa-solid fa-circle-check text-2xl"></i>
                            <div>
                                <p class="font-bold">THUẬT TOÁN ĐÃ HỘI TỤ!</p>
                                <p class="text-sm">Các điểm không thay đổi nhóm tại lần lặp thứ ${iter}. Kết thúc thuật toán.</p>
                            </div>
                        </div>
                    `;
                    break;
                }
                prevAssignments = assignments;
            }
        }

        // --- 3. RENDERING UI & CHARTS ---

        function renderIteration(iter, points, centers, assignments, title, isInit, tableRows = "", calcHtml = "", oldCenters = null) {
            const containerId = `iter_${iter}`;
            const chartId = `chart_${iter}`;
            
            let html = `
                <div class="step-card bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200 mb-10">
                    <div class="bg-slate-50 border-b px-6 py-4 flex justify-between items-center">
                        <h3 class="font-bold text-lg text-slate-700">${title}</h3>
                        <span class="text-xs font-mono bg-slate-200 px-2 py-1 rounded text-slate-600">Step ${iter}</span>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left: Chart -->
                            <div class="chart-wrapper border rounded-lg p-2 bg-white shadow-sm min-h-[400px]">
                                <div id="${chartId}" style="width:100%; height:100%;"></div>
                            </div>

                            <!-- Right: Data -->
                            <div class="space-y-6">
                                ${!isInit ? `
                                    <div>
                                        <h4 class="text-sm font-bold text-slate-700 uppercase mb-3 border-l-4 border-blue-500 pl-2">1. Tính Khoảng Cách & Gán Nhóm</h4>
                                        <div class="overflow-x-auto max-h-[300px] border rounded custom-scrollbar">
                                            <table class="w-full text-sm text-left whitespace-nowrap">
                                                <thead class="bg-slate-100 text-xs uppercase font-semibold text-slate-600 sticky top-0">
                                                    <tr>
                                                        <th class="px-4 py-2">STT</th>
                                                        <th class="px-4 py-2">Điểm</th>
                                                        <th class="px-4 py-2 text-red-600">D -> C1</th>
                                                        <th class="px-4 py-2 text-green-600">D -> C2</th>
                                                        <th class="px-4 py-2 text-blue-600">D -> C3</th>
                                                        <th class="px-4 py-2">Nhóm</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="divide-y divide-slate-100">${tableRows}</tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div>
                                        <h4 class="text-sm font-bold text-slate-700 uppercase mb-3 border-l-4 border-purple-500 pl-2">2. Cập Nhật Tâm Mới</h4>
                                        ${calcHtml}
                                    </div>
                                ` : `
                                    <div class="flex flex-col justify-center h-full space-y-4">
                                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                                            <p class="font-semibold text-blue-800">Tâm ban đầu được chọn:</p>
                                            <ul class="list-disc list-inside mt-2 space-y-1 text-sm text-slate-700">
                                                <li><span class="font-bold text-red-600">C1:</span> (${centers[0].x}, ${centers[0].y})</li>
                                                <li><span class="font-bold text-green-600">C2:</span> (${centers[1].x}, ${centers[1].y})</li>
                                                <li><span class="font-bold text-blue-600">C3:</span> (${centers[2].x}, ${centers[2].y})</li>
                                            </ul>
                                        </div>
                                        <p class="text-sm text-slate-500 italic text-center">Biểu đồ bên trái hiển thị vị trí các điểm dữ liệu và 3 tâm khởi tạo.</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('resultArea').innerHTML += html;

            // Draw Chart
            setTimeout(() => {
                drawPlotlyChart(chartId, points, centers, assignments, isInit, oldCenters);
            }, 50);
        }

        function drawPlotlyChart(divId, points, centers, assignments, isInit, oldCenters) {
            let traces = [];
            const colors = ['#ef4444', '#22c55e', '#3b82f6']; // Tailwind Red-500, Green-500, Blue-500
            
            // 1. Vẽ các điểm dữ liệu
            if (isInit) {
                traces.push({
                    x: points.map(p => p.x), y: points.map(p => p.y),
                    mode: 'markers+text', type: 'scatter',
                    text: points.map(p => p.id), textposition: 'top center',
                    marker: { size: 10, color: '#94a3b8' }, // Slate-400
                    name: 'Điểm dữ liệu'
                });
            } else {
                for(let c=0; c<3; c++) {
                    let clusterPoints = points.filter((p, i) => assignments[i] === c);
                    traces.push({
                        x: clusterPoints.map(p => p.x), y: clusterPoints.map(p => p.y),
                        mode: 'markers+text', type: 'scatter',
                        text: clusterPoints.map(p => p.id), textposition: 'top center',
                        marker: { size: 10, color: colors[c], opacity: 0.7 },
                        name: `Cụm ${c+1}`
                    });
                }
            }

            // 2. Vẽ Tâm Cũ (Mờ đi) để thấy hướng di chuyển
            if (oldCenters) {
                traces.push({
                    x: oldCenters.map(c => c.x), y: oldCenters.map(c => c.y),
                    mode: 'markers', type: 'scatter',
                    marker: { size: 12, symbol: 'x', color: colors, opacity: 0.4 },
                    name: 'Tâm Cũ', hoverinfo: 'none'
                });
            }

            // 3. Vẽ Tâm Hiện Tại (Ngôi sao lớn)
            traces.push({
                x: centers.map(c => c.x), y: centers.map(c => c.y),
                mode: 'markers', type: 'scatter',
                marker: { 
                    size: 18, symbol: 'star', 
                    color: colors, 
                    line: {width: 2, color: 'black'} 
                },
                name: isInit ? 'Tâm Gốc' : 'Tâm Mới'
            });

            // Layout đẹp
            let layout = {
                margin: {t: 30, b: 40, l: 40, r: 20},
                xaxis: { title: 'X1', showgrid: true, gridcolor: '#e2e8f0' },
                yaxis: { title: 'X2', showgrid: true, gridcolor: '#e2e8f0' },
                paper_bgcolor: 'white', plot_bgcolor: 'white',
                legend: { orientation: 'h', y: -0.2 },
                hovermode: 'closest',
                height: 400
            };
            
            // Cấu hình responsive
            let config = { responsive: true, displayModeBar: false };

            Plotly.newPlot(divId, traces, layout, config);
        }

    </script>
</body>
</html>
